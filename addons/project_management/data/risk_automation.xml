<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Automated Action: Tự động phân tích rủi ro khi task thay đổi -->
        <record id="auto_action_task_change_trigger_risk" model="base.automation">
            <field name="name">AI: Auto Risk Analysis on Task Changes</field>
            <field name="model_id" ref="quan_ly_cong_viec.model_cong_viec"/>
            <field name="active" eval="True"/>
            <field name="trigger">on_create_or_write</field>
            <field name="filter_domain">[('du_an_id', '!=', False)]</field>
            <field name="code">
# Tự động chạy AI phân tích rủi ro khi task thay đổi
for record in records:
    if record.du_an_id:
        try:
            ai_engine = env['risk.ai.engine']
            ai_engine.analyze_project_risks(record.du_an_id.id)
            log(f"Auto AI risk analysis triggered by task {record.ten_cong_viec}")
        except Exception as e:
            log(f"AI analysis failed: {str(e)}", level='error')
            </field>
        </record>

        <!-- Automated Action: Tự động phân tích rủi ro khi budget/expense thay đổi -->
        <record id="auto_action_budget_change_trigger_risk" model="base.automation">
            <field name="name">AI: Auto Risk Analysis on Budget Changes</field>
            <field name="model_id" ref="model_budgets"/>
            <field name="active" eval="True"/>
            <field name="trigger">on_create_or_write</field>
            <field name="filter_domain">[('projects_id', '!=', False)]</field>
            <field name="code">
# Tự động chạy AI phân tích rủi ro khi budget thay đổi
for record in records:
    if record.projects_id:
        try:
            ai_engine = env['risk.ai.engine']
            ai_engine.analyze_project_risks(record.projects_id.id)
            log(f"Auto AI risk analysis triggered by budget change")
        except Exception as e:
            log(f"AI analysis failed: {str(e)}", level='error')
            </field>
        </record>

        <!-- Automated Action: Tự động phân tích rủi ro khi expense thay đổi -->
        <record id="auto_action_expense_change_trigger_risk" model="base.automation">
            <field name="name">AI: Auto Risk Analysis on Expense Changes</field>
            <field name="model_id" ref="model_expenses"/>
            <field name="active" eval="True"/>
            <field name="trigger">on_create_or_write</field>
            <field name="filter_domain">[('projects_id', '!=', False)]</field>
            <field name="code">
# Tự động chạy AI phân tích rủi ro khi expense thay đổi
for record in records:
    if record.projects_id:
        try:
            ai_engine = env['risk.ai.engine']
            ai_engine.analyze_project_risks(record.projects_id.id)
            log(f"Auto AI risk analysis triggered by expense: {record.expense_amount}")
        except Exception as e:
            log(f"AI analysis failed: {str(e)}", level='error')
            </field>
        </record>

        <!-- Automated Action: Gửi email cảnh báo khi phát hiện Critical Risk -->
        <record id="auto_action_critical_risk_email_alert" model="base.automation">
            <field name="name">Alert: Send Email on Critical Risk Detection</field>
            <field name="model_id" ref="model_risk_assessment"/>
            <field name="active" eval="True"/>
            <field name="trigger">on_create</field>
            <field name="filter_domain">[('risk_level', '=', 'critical'), ('is_ai_detected', '=', True)]</field>
            <field name="code">
# Gửi email cảnh báo khi AI phát hiện rủi ro nghiêm trọng
for risk in records:
    if risk.project_id and risk.project_id.manager_name:
        # Tạo activity cho PM
        risk.project_id.activity_schedule(
            activity_type_id=env.ref('mail.mail_activity_data_warning').id,
            summary=f"Rủi ro nghiêm trọng: {risk.name}",
            note=f"AI đã phát hiện rủi ro nghiêm trọng trong dự án {risk.project_id.projects_name}:\n\n"
                 f"Loại: {dict(risk._fields['risk_type'].selection).get(risk.risk_type)}\n"
                 f"Điểm rủi ro: {risk.risk_score:.1f}/100\n"
                 f"Xác suất: {risk.probability}%\n\n"
                 f"Hành động ngay để giảm thiểu rủi ro!",
            user_id=risk.project_id.manager_name.user_id.id if risk.project_id.manager_name.user_id else env.user.id,
        )
        log(f"Critical risk alert created for {risk.project_id.projects_name}")
            </field>
        </record>

    </data>
</odoo>
