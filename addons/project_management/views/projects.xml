<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <record id="view_projects_form" model="ir.ui.view">
            <field name="name">projects.form</field>
            <field name="model">projects</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <!-- N√∫t G·ª≠i x√©t duy·ªát - hi·ªÉn th·ªã khi ·ªü tr·∫°ng th√°i Nh√°p -->
                        <button name="action_submit_approval" 
                                string="G·ª≠i x√©t duy·ªát" 
                                type="object" 
                                class="btn-primary"
                                attrs="{'invisible': [('approval_state', '!=', 'draft')]}"/>
                        
                        <!-- N√∫t Ph√™ duy·ªát - hi·ªÉn th·ªã khi Ch·ªù x√©t duy·ªát -->
                        <button name="action_approve" 
                                string="Ph√™ duy·ªát" 
                                type="object" 
                                class="btn-success"
                                attrs="{'invisible': [('approval_state', '!=', 'pending')]}"/>
                        
                        <!-- N√∫t T·ª´ ch·ªëi - hi·ªÉn th·ªã khi Ch·ªù x√©t duy·ªát -->
                        <button name="action_reject" 
                                string="T·ª´ ch·ªëi" 
                                type="object" 
                                class="btn-danger"
                                attrs="{'invisible': [('approval_state', '!=', 'pending')]}"/>
                        
                        <!-- N√∫t ƒê·∫∑t l·∫°i nh√°p - hi·ªÉn th·ªã khi T·ª´ ch·ªëi -->
                        <button name="action_reset_draft" 
                                string="ƒê·∫∑t l·∫°i nh√°p" 
                                type="object" 
                                attrs="{'invisible': [('approval_state', '!=', 'rejected')]}"/>
                        
                        <!-- N√∫t In PDF - hi·ªÉn th·ªã khi ƒê√£ ph√™ duy·ªát -->
                        <button name="action_print_approval_pdf" 
                                string="In PDF ph√™ duy·ªát" 
                                type="object" 
                                class="btn-secondary"
                                attrs="{'invisible': [('approval_state', '!=', 'approved')]}"/>
                        
                        <!-- Status bar tr·∫°ng th√°i duy·ªát -->
                        <field name="approval_state" widget="statusbar" 
                               statusbar_visible="draft,pending,approved"
                               style="margin-right: 20px;"/>
                    </header>
                    <sheet>
                        <group col="2">
                            <group>
                                <field name="projects_id"/>
                                <field name="projects_name"/>
                                <field name="manager_name"/>
                            </group>
                            <group>
                                <field name="start_date"/>
                                <field name="actual_end_date"/>
                                <field name="progress"/>
                                <field name="status"
                                    decoration-muted="status == 'not_started'"
                                    decoration-warning="status == 'in_progress'"
                                    decoration-success="status == 'completed'"  
                                    decoration-info="status == 'delayed'"
                                    decoration-danger="status == 'cancelled'"                           
                                />
                                <field name="ly_do_1"
                                    attrs="{'invisible': [('status', 'not in', ['cancelled', 'delayed'])]}"
                                    string="L√Ω do"
                                    placeholder="Nh·∫≠p l√Ω do h·ªßy b·ªè ho·∫∑c tr√¨ ho√£n..."
                                />
                            </group>
                            
                        </group>

                        <notebook>
                            <page string="Th√¥ng tin d·ª± √°n">
                                <group col="6">                                    
                                    <field name="projects_id" newline="1"/>
                                    <field name="projects_name"/>
                                    <field name="manager_name"/>
                                    <field name="start_date"/>
                                    <field name="actual_end_date"/>
                                    <field name="progress"/>
                                    <field name="status" newline="1"/>
                                </group>
                            </page>
                            <page string="C√¥ng vi·ªác d·ª± √°n">
                                <field name="task_ids">
                                    <tree editable="bottom">
                                        <field name="ma_cong_viec"/>
                                        <field name="ten_cong_viec"/>
                                        <field name="nguoi_phu_trach_id" options="{'no_create': True}"/>
                                        <field name="nhan_vien_phan_cong_ids" widget="many2many_tags" options="{'no_create': True, 'no_open': False}"/>
                                        <field name="ngay_bat_dau"/>
                                        <field name="ngay_ket_thuc"/>
                                        <field name="muc_do_uu_tien"/>
                                        <field name="ti_le_hoan_thanh" widget="progressbar"/>
                                        <field name="trang_thai"
                                            decoration-muted="trang_thai == 'moi'"
                                            decoration-warning="trang_thai == 'dang_thuc_hien'"
                                            decoration-success="trang_thai == 'hoan_thanh'"
                                            decoration-info="trang_thai == 'tam_dung'"
                                        />
                                    </tree>
                                </field>
                            </page>
                            <page string="Ng√¢n s√°ch d·ª± √°n">
                                <field name="budget_ids">
                                    <tree editable="bottom">
                                        <field name="budgets_id"/>
                                        <field name="budgets_name"/>
                                        <field name="budget_planned"/>
                                        <field name="budget_allocated"/>
                                        <field name="budget_spent"/>
                                        <field name="budget_difference"/>
                                    </tree>
                                </field>
                            </page>
                            <!-- Tab X√©t duy·ªát d·ª± √°n -->
                            <page string="X√©t duy·ªát d·ª± √°n">
                                <group col="2">
                                    <group string="Th√¥ng tin x√©t duy·ªát">
                                        <field name="approval_state" readonly="1"/>
                                        <field name="approver_id" readonly="1"/>
                                        <field name="approval_date" readonly="1"/>
                                    </group>
                                    <group string="Ch·ªØ k√Ω ph√™ duy·ªát" 
                                           attrs="{'invisible': [('approval_state', 'not in', ['pending', 'approved'])]}">
                                        <field name="approval_signature" widget="signature" 
                                               attrs="{'readonly': [('approval_state', '=', 'approved')]}"/>
                                    </group>
                                </group>
                                <group string="L√Ω do t·ª´ ch·ªëi" 
                                       attrs="{'invisible': [('approval_state', 'not in', ['pending', 'rejected'])]}">
                                    <field name="rejection_reason" nolabel="1" 
                                           placeholder="Nh·∫≠p l√Ω do t·ª´ ch·ªëi d·ª± √°n..."
                                           attrs="{'readonly': [('approval_state', '=', 'rejected')]}"/>
                                </group>
                            </page>
                            
                            <!-- Tab Qu·∫£n l√Ω r·ªßi ro AI -->
                            <page string="Qu·∫£n l√Ω r·ªßi ro">
                                <div class="alert alert-success" role="alert" style="margin-bottom: 15px;">
                                    <h4>‚ú® AI Risk Management - T·ª± ƒë·ªông ph√°t hi·ªán &amp; ph√¢n t√≠ch</h4>
                                    <p><strong>AI ƒëang ho·∫°t ƒë·ªông 24/7:</strong></p>
                                    <ul class="mb-0">
                                        <li>‚úÖ <strong>T·ª± ƒë·ªông qu√©t</strong> khi b·∫°n t·∫°o/c·∫≠p nh·∫≠t d·ª± √°n, task, ng√¢n s√°ch</li>
                                        <li>‚úÖ <strong>Ph√¢n t√≠ch h√†ng ng√†y</strong> l√∫c 2:00 AM cho t·∫•t c·∫£ d·ª± √°n</li>
                                        <li>‚úÖ <strong>C·∫£nh b√°o real-time</strong> khi ph√°t hi·ªán r·ªßi ro nghi√™m tr·ªçng</li>
                                        <li>‚úÖ <strong>G·ª£i √Ω gi·∫£i ph√°p</strong> t·ª± ƒë·ªông cho m·ªói r·ªßi ro</li>
                                    </ul>
                                </div>
                                
                                <!-- N√∫t ph√¢n t√≠ch AI th·ªß c√¥ng -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <button name="action_analyze_risks" 
                                                string="üîç Ch·∫°y AI ngay b√¢y gi·ªù (Manual Trigger)" 
                                                type="object" 
                                                class="btn btn-primary"
                                                help="Click ƒë·ªÉ ch·∫°y AI ph√¢n t√≠ch ngay l·∫≠p t·ª©c (AI c≈©ng t·ª± ƒë·ªông ch·∫°y khi c√≥ thay ƒë·ªïi)"/>
                                        <span class="text-muted ml-2">
                                            <i class="fa fa-info-circle"/> AI t·ª± ƒë·ªông ch·∫°y khi b·∫°n thay ƒë·ªïi ti·∫øn ƒë·ªô, deadline, task ho·∫∑c ng√¢n s√°ch
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Th·ªëng k√™ r·ªßi ro -->
                                <group>
                                    <group>
                                        <field name="risk_count" readonly="1"/>
                                        <field name="critical_risk_count" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="high_risk_count" readonly="1"/>
                                    </group>
                                </group>
                                
                                <!-- Danh s√°ch r·ªßi ro -->
                                <field name="risk_ids" context="{'default_project_id': active_id}">
                                    <tree decoration-danger="risk_level == 'critical'" 
                                          decoration-warning="risk_level == 'high'"
                                          decoration-info="risk_level == 'medium'"
                                          decoration-success="status == 'resolved'">
                                        <field name="name"/>
                                        <field name="risk_type"/>
                                        <field name="risk_level" 
                                               decoration-success="risk_level == 'low'"
                                               decoration-warning="risk_level == 'medium'"
                                               decoration-danger="risk_level in ['high', 'critical']"/>
                                        <field name="probability" widget="percentage"/>
                                        <field name="impact_score"/>
                                        <field name="risk_score" widget="progressbar"/>
                                        <field name="status" 
                                               decoration-success="status == 'resolved'"
                                               decoration-warning="status == 'mitigating'"
                                               decoration-info="status == 'analyzing'"/>
                                        <field name="assigned_to"/>
                                        <field name="detected_date"/>
                                        <field name="is_ai_detected" string="AI" widget="boolean"/>
                                    </tree>
                                </field>
                                
                                <!-- Ch·ªâ s·ªë theo d√µi -->
                                <separator string="Ch·ªâ s·ªë theo d√µi (Metrics)"/>
                                <field name="risk_metric_ids" context="{'default_project_id': active_id}">
                                    <tree decoration-danger="is_anomaly == True" editable="bottom">
                                        <field name="date"/>
                                        <field name="metric_type"/>
                                        <field name="value"/>
                                        <field name="threshold_min"/>
                                        <field name="threshold_max"/>
                                        <field name="is_anomaly" widget="boolean_toggle"/>
                                        <field name="notes"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>


                    </sheet>
                </form>
            </field>
        </record>


        <record id="view_projects_tree" model="ir.ui.view">
            <field name="name">projects.tree</field>
            <field name="model">projects</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="projects_id"/>
                    <field name="projects_name"/>
                    <field name="manager_name"/>
                    <field name="start_date"/>
                    <field name="actual_end_date"/>
                    <field name="progress"/>
                    <field name="status"
                        decoration-muted="status == 'not_started'"
                        decoration-warning="status == 'in_progress'"
                        decoration-success="status == 'completed'"
                        decoration-info="status == 'delayed'"
                        decoration-danger="status == 'cancelled'"  
                    />
                    <field name="approval_state"
                        decoration-muted="approval_state == 'draft'"
                        decoration-info="approval_state == 'pending'"
                        decoration-success="approval_state == 'approved'"
                        decoration-danger="approval_state == 'rejected'"
                    />
                    <button string="Xem Bi·ªÉu ƒê·ªì C√¥ng Vi·ªác" type="object" name="action_view_task_chart" class="btn-primary"/>              
                </tree>
            </field>
        </record>

        <record id="view_projects_search" model="ir.ui.view">
            <field name="name">projects.search</field>
            <field name="model">projects</field>
            <field name="arch" type="xml">
                <search>
                    <field name="projects_id"/>
                    <field name="projects_name"/>
                    <field name="manager_name"/>
                    <field name="start_date"/>
                    <field name="actual_end_date"/>
                    <field name="progress"/>
                    <field name="status"/>
                    <field name="approval_state"/>
                    <filter name="filter_draft" string="Nh√°p" domain="[('approval_state', '=', 'draft')]"/>
                    <filter name="filter_pending" string="Ch·ªù duy·ªát" domain="[('approval_state', '=', 'pending')]"/>
                    <filter name="filter_approved" string="ƒê√£ duy·ªát" domain="[('approval_state', '=', 'approved')]"/>
                    <filter name="filter_rejected" string="T·ª´ ch·ªëi" domain="[('approval_state', '=', 'rejected')]"/>
                    <separator/>
                    <group expand="0" string="Nh√≥m theo">
                        <filter name="group_approval_state" string="Tr·∫°ng th√°i duy·ªát" context="{'group_by': 'approval_state'}"/>
                        <filter name="group_status" string="Tr·∫°ng th√°i" context="{'group_by': 'status'}"/>
                    </group>
                </search>
            </field>
        </record>

        <record id="action_projects" model="ir.actions.act_window">
        <field name="name">D·ª± √Ån</field>
            <field name="res_model">projects</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="view_projects_search"/>
        </record>
        
    </data>
</odoo>